<script>
/* ===== â˜° Sections: open + smooth scroll (robust) ===== */
(function(){
  const btn   = document.getElementById('sectionsToggle');
  const panel = document.getElementById('sectionsPanel');
  if(!btn || !panel) return;

  const collapsibleIds = ['about','awards','consult','faq','contact'];
  const headerH = () => (parseInt(getComputedStyle(document.documentElement).getPropertyValue('--headerH'))||64) + 12;
  const isDetails = el => !!el && el.tagName === 'DETAILS';

  function closeAllDetails(exceptId){
    collapsibleIds.forEach(id=>{
      if(id===exceptId) return;
      const d = document.getElementById(id)?.querySelector('details.collapsible');
      if(isDetails(d)) d.removeAttribute('open');
    });
  }

  function offsetScrollTo(el){
    const top = el.getBoundingClientRect().top + window.scrollY - headerH();
    window.scrollTo({ top: Math.max(0, top), behavior:'smooth' });
  }

  function openSection(id){
    const wrap = document.getElementById(id);
    if(!wrap) return;

    const d = wrap.querySelector('details.collapsible');
    if(isDetails(d)){
      if(!d.open) d.open = true;
      closeAllDetails(id);
      // wait a frame so layout settles, then scroll
      requestAnimationFrame(()=> setTimeout(()=> offsetScrollTo(d), 50));
    }else{
      requestAnimationFrame(()=> setTimeout(()=> offsetScrollTo(wrap), 10));
    }
  }

  function openPanel(){ panel.hidden = false; btn.setAttribute('aria-expanded','true'); }
  function closePanel(){ panel.hidden = true; btn.setAttribute('aria-expanded','false'); }
  function togglePanel(){ (panel.hidden ? openPanel : closePanel)(); }

  btn.addEventListener('click', togglePanel, {passive:true});

  // Use history hash so back button works; then drive scroll via hashchange handler
  panel.addEventListener('click', (e)=>{
    const a = e.target.closest('a[data-section]');
    if(!a) return;
    e.preventDefault();
    const id = a.getAttribute('data-section');
    closePanel();
    // push hash (no full page jump), then handle in hash handler
    history.pushState(null, '', '#'+id);
    // also open immediately for browsers that delay hashchange
    openSection(id);
  });

  document.addEventListener('click', (e)=>{
    if(panel.hidden) return;
    if(e.target === btn || panel.contains(e.target)) return;
    closePanel();
  }, {passive:true});
  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape' && !panel.hidden) closePanel();
  }, {passive:true});

  // Handle direct hash navigation and back/forward
  function openFromHash(){
    const id = (location.hash||'').slice(1);
    if(!id) return;
    openSection(id);
  }
  window.addEventListener('hashchange', openFromHash, {passive:true});
  if(location.hash) setTimeout(openFromHash, 120);

  // Keep accordion behavior if user taps the section header directly
  document.querySelectorAll('details.collapsible > summary').forEach(sum=>{
    sum.addEventListener('click', ()=>{
      const sec = sum.closest('section')?.id;
      if(sec) closeAllDetails(sec);
      // scroll to the details container itself (header offset)
      const d = sum.parentElement;
      requestAnimationFrame(()=> setTimeout(()=> offsetScrollTo(d), 30));
    }, {passive:true});
  });
})();
</script>
